!function(){function a(a){function b(a){i.creatingOffer?(i.participants||(i.participants=[]),i.participants[i.participants.length]=a):(i.creatingOffer=!0,d(a),setTimeout(function(){i.creatingOffer=!1,i.participants&&i.participants.length&&e()},1e3))}function d(b){var c=n;c.to=b,c.stream=a.stream,c.establishDataChannel=a.establishDataChannel,k[b]=p.createOffer(c)}function e(){var a=i.participants[0];a&&(i.creatingOffer=!0,d(a),delete i.participants[0],i.participants=f(i.participants),setTimeout(function(){i.creatingOffer=!1,i.participants[0]&&e()},1e3))}function g(){i.signal({leaving:!0}),i.isbroadcaster&&(i.stopBroadcasting=!0),a.stream&&a.stream.stop(),window.Firebase&&o.remove()}var h=a.userid||c(),i=this;i.userid=h;var k={},l={};this.onmessage=function(c){i.peers=k,console.log(c),c.roomid&&c.broadcasting&&!i.sentParticipationRequest?a.onmeeting(c):console.debug(JSON.stringify(c,function(a,b){return b&&b.sdp?"":b},"---")),c.sdp&&c.to==h&&this.onsdp(c),c.candidate&&c.to==h&&this.onice(c),c.participationRequest&&c.to==h&&b(c.userid),c.conferencing&&c.newcomer!=h&&0==!!l[c.newcomer]&&(l[c.newcomer]=c.newcomer,a.stream&&i.signal({participationRequest:!0,to:c.newcomer}))},this.onsdp=function(b){var c=b.sdp;if("offer"==c.type){var d=n;d.stream=a.stream,d.sdp=c,d.to=b.userid,d.establishDataChannel=a.establishDataChannel,k[b.userid]=q.createAnswer(d)}"answer"==c.type&&k[b.userid].setRemoteDescription(c)};var m=[];this.onice=function(a){var b=k[a.userid];if(b){b.addIceCandidate(a.candidate);for(var c=0;c<m.length;c++)b.addIceCandidate(m[c]);m=[]}else m.push(m)};var n={onsdp:function(a,b){i.signal({sdp:a,to:b})},onicecandidate:function(a,b){i.signal({candidate:a,to:b})},onaddstream:function(b,c){function d(){return navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile/i)?e():void(f.readyState<=HTMLMediaElement.HAVE_CURRENT_DATA||f.paused||f.currentTime<=0?setTimeout(d,300):e())}function e(){i.isbroadcaster&&i.signal({conferencing:!0,newcomer:c}),a.onaddstream&&a.onaddstream({video:f,stream:b,userid:c,type:"remote"})}console.debug("onaddstream",">>>>>>",b),b.onended=function(){a.onuserleft&&a.onuserleft(c)};var f=document.createElement("video");f.id=c,f[j?"mozSrcObject":"src"]=j?b:window.webkitURL.createObjectURL(b),f.autoplay=!0,f.controls=!0,f.play(),d()}};this.broadcast=function(b){i.roomid=b.roomid||c(),i.isbroadcaster=!0,function d(){i.signal({roomid:i.roomid,broadcasting:!0}),i.stopBroadcasting||a.transmitOnce||setTimeout(d,3e3)}(),o.onDisconnect&&o.onDisconnect().remove()},this.join=function(a){i.roomid=a.roomid,this.signal({participationRequest:!0,to:a.to}),i.sentParticipationRequest=!0},window.onbeforeunload=function(){g()},window.onkeyup=function(a){116==a.keyCode&&g()},a.leave=g;var o;if(this.setSocket=function(a){o=a},a.openSignalingChannel)a.openSignalingChannel(function(b){b=JSON.parse(b),b.userid!=h&&(b.leaving?a.onuserleft&&a.onuserleft(b.userid):i.onmessage(b))}),this.signal=function(a){a.userid=h,o.send(JSON.stringify(a))};else{if(!window.Firebase)throw"You must link <https://cdn.firebase.com/v0/firebase.js> file.";o=new window.Firebase("https://"+(a.firebase||"chat")+".firebaseIO.com/"+a.channel),o.on("child_added",function(b){var c=b.val();c.userid!=h&&(c.leaving?a.onuserleft&&a.onuserleft(c.userid):i.onmessage(c)),c.userid!=h&&b.ref().remove()}),this.signal=function(a){a.userid=h,o.push(a)}}}function b(a,c){if(!m){if(!c)return b(a,!0);m=!0;var d=document.createElement("iframe");d.onload=function(){d.isLoaded=!0,window.addEventListener("message",function(b){b.data&&b.data.iceServers&&a(b.data.iceServers)}),d.contentWindow.postMessage("get-ice-servers","*")},d.src="https://cdn.webrtc-experiment.com/getIceServers/",d.style.display="none",(document.body||document.documentElement).appendChild(d)}}function c(){return Math.round(9999999999*Math.random())+9999999999}function d(){}function e(a){console.error("sdp error:",JSON.stringify(a,null,"	"))}function f(a){for(var b=[],c=a.length,d=0;c>d;d++)a[d]&&a[d]!==!0&&(b[b.length]=a[d]);return b}window.Meeting=function(b){function c(){console.log("initing signaler"),e=new a(f),f.signaler=e}function d(a){function b(b){b.onended=function(){f.onuserleft&&f.onuserleft("self")},f.stream=b;var c=document.createElement("video");c.id="self",c[j?"mozSrcObject":"src"]=j?b:window.webkitURL.createObjectURL(b),c.autoplay=!0,c.controls=!0,c.muted=!0,c.volume=0,c.play(),f.onaddstream({video:c,stream:b,userid:"self",type:"local"}),a(b)}function c(a){console.error(a)}var d={audio:!0,video:!0};navigator.getUserMedia(d,b,c)}var e,f=this;this.channel=b||location.href.replace(/\/|:|#|%|\.|\[|\]/g,""),this.onmeeting=function(a){f.detectedRoom||(f.detectedRoom=!0,f.meet(a))},this.setup=function(a){d(function(){!e&&c(),e.broadcast({roomid:a||f.channel})})},this.meet=function(a){d(function(){!e&&c(),e.join({to:a.userid,roomid:a.roomid})})},this.getSignaler=function(){return this.signaler},this.check=c};var g=window.mozRTCPeerConnection||window.webkitRTCPeerConnection,h=window.mozRTCSessionDescription||window.RTCSessionDescription,i=window.mozRTCIceCandidate||window.RTCIceCandidate;navigator.getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia,window.URL=window.webkitURL||window.URL;var j=!!navigator.mozGetUserMedia,k=(!!navigator.webkitGetUserMedia,[]);k.push({url:"stun:stun.l.google.com:19302"}),k.push({url:"stun:stun.anyfirewall.com:3478"}),k.push({url:"turn:turn.bistri.com:80",credential:"homeo",username:"homeo"}),k.push({url:"turn:turn.anyfirewall.com:443?transport=tcp",credential:"webrtc",username:"webrtc"});var l={iceServers:k};b(function(a){l.iceServers=l.iceServers.concat(a)});var m,n={optional:[{RtpDataChannels:!0},{DtlsSrtpKeyAgreement:!0}]},o={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},p={createOffer:function(a){var b=new g(l,n),c=b.createDataChannel("blah",{reliable:!1});return console.log("creating data channel offer"),a.stream&&b.addStream(a.stream),a.establishDataChannel&&a.establishDataChannel(c),b.onaddstream=function(b){a.onaddstream(b.stream,a.to)},b.onicecandidate=function(b){a.onicecandidate(b.candidate,a.to)},b.createOffer(function(c){b.setLocalDescription(c),a.onsdp(c,a.to)},e,o),this.peer=b,this},setRemoteDescription:function(a){this.peer.setRemoteDescription(new h(a),d,e)},addIceCandidate:function(a){this.peer.addIceCandidate(new i({sdpMLineIndex:a.sdpMLineIndex,candidate:a.candidate}))}},q={createAnswer:function(a){var b=new g(l,n),c=b.createDataChannel("blah",{reliable:!1});return console.log("creating data channel answer"),a.stream&&b.addStream(a.stream),a.establishDataChannel&&a.establishDataChannel(c),b.onaddstream=function(b){a.onaddstream(b.stream,a.to)},b.onicecandidate=function(b){a.onicecandidate(b.candidate,a.to)},b.setRemoteDescription(new h(a.sdp),d,e),b.createAnswer(function(c){b.setLocalDescription(c),a.onsdp(c,a.to)},e,o),this.peer=b,this},addIceCandidate:function(a){this.peer.addIceCandidate(new i({sdpMLineIndex:a.sdpMLineIndex,candidate:a.candidate}))}}}();