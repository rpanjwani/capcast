function nudgeRecognition(){setTimeout(function(){if(!recognitionHappened){console.log("nudging...");try{recognition.start()}catch(a){console.log(a)}}recognitionHappened=!1,nudgeRecognition()},1e4)}function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function generateRoom(){var a=function(){return Math.floor(65536*Math.random()).toString(16)};return a()+"-"+a()}function generateRoomLink(){document.getElementById("room-link").innerHTML=location.href+"?serverIp="+currentOpenIp+"&roomId="+currentOpenChannel,document.getElementById("room-div").style.visibility="visible"}function initWs(a,b){var c=new WebSocket("ws://"+nextIp+port);console.log("connecting to "+nextIp),currentIp=nextIp,c.onopen=function(){currentOpenIp=currentIp,currentOpenChannel=a,console.log("opening "+nextIp),c.push(JSON.stringify({open:!0,channel:a})),qsRoomId||currentOpenIp==loadBalancerIp||(meeting.setup(currentOpenChannel),generateRoomLink(),document.getElementById("videos").style.visibility="visible"),meeting.getSignaler()&&(console.log("checking websocket: "+c),meeting.getSignaler().setSocket(c))},c.push=c.send,c.send=function(b){return 1!=c.readyState?setTimeout(function(){c.send(b)},300):void c.push(JSON.stringify({data:b,channel:a}))},c.onmessage=function(a){currentIp===loadBalancerIp&&(nextIp=JSON.parse(JSON.parse(a.data)).publicIp,nextIp&&(console.log("closing connection to load balancer and connecting directly to server "+nextIp),c.close())),b(JSON.parse(a.data))},c.onclose=function(c){setTimeout(function(){currentIp!=loadBalancerIp&&(nextIp=loadBalancerIp),console.log(currentIp+" closed."),initWs(a,b)},3e3)},c.onerror=function(a){console.log("error on socket "+currentIp+". Closing the socket.")}}var recognition=new webkitSpeechRecognition,dataChannel;recognition.continuous=!0,recognition.interimResults=!0,recognition.lang="en-US",recognition.onresult=function(a){recognitionHappened=!0;for(var b="",c=a.resultIndex;c<a.results.length;++c)a.results[c].isFinal&&(b+=a.results[c][0].transcript);console.log("recognized "+b),dataChannel&&(console.log("sending data channel message"+b),dataChannel.send(b))};var recognitionHappened=!1,qsRoomId=getParameterByName("roomId"),qsServerIp=getParameterByName("serverIp");console.log("qsServerIp: "+qsServerIp+" qsRoomId: "+qsRoomId);var meeting=new Meeting,meetingRooms={};meeting.onmeeting=function(a){meetingRooms[a.roomid]||(meetingRooms[a.roomid]=a,qsRoomId===a.roomid&&(meeting.meet(a),videos.style.visibility="visible"))},meeting.establishDataChannel=function(a){dataChannel=a,dataChannel.onmessage=function(a){console.log("Got Data Channel Message:",a.data),document.getElementById("captions").innerHTML+="\n<span class='user-id'>"+meeting.getSignaler().userid+"</span>: "+a.data+"<br/>"},dataChannel.onopen=function(){},dataChannel.onclose=function(a){console.error(a)},dataChannel.onerror=function(a){console.error(a)}};var remoteMediaStreams=document.getElementById("remote-streams-container"),localMediaStream=document.getElementById("local-streams-container");meeting.onaddstream=function(a){"local"==a.type&&localMediaStream.appendChild(a.video),"remote"==a.type&&remoteMediaStreams.insertBefore(a.video,remoteMediaStreams.firstChild),recognition.start(),nudgeRecognition()};var loadBalancerIp="capcast-lb-2000459634.us-west-2.elb.amazonaws.com",port=":12034",currentIp=loadBalancerIp,nextIp=currentIp,currentOpenIp,currentOpenChannel;meeting.openSignalingChannel=function(a){if(qsServerIp&&qsRoomId)nextIp=qsServerIp,initWs(qsRoomId,a);else{var b=generateRoom();initWs(b,a)}},meeting.onuserleft=function(a){var b=document.getElementById(a);b&&b.parentNode.removeChild(b)},meeting.check();